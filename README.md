# AI交易决策助手

## 项目简介

这是一个基于大型语言模型（LLM）的AI交易决策助手原型。项目旨在通过将金融市场数据（K线、技术指标）、新闻和公司财务摘要转化为自然语言描述，结合用户的风险偏好和当前持仓状态，利用LLM的强大推理能力生成包含**具体交易规模**的结构化交易决策。

本项目的核心思想是利用LLM的“少样本学习”（Few-Shot Learning）能力，通过精心设计的Prompt和模块化的Agent架构，实现高效、灵活、动态的交易策略生成，并内置了**规则化风险管理**模块，而无需传统的机器学习模型训练。

## 核心功能 ✨

-   **LLM驱动决策**: 利用DeepSeek API作为核心推理引擎，根据多维度信息（技术面、基本面、新闻面、持仓状态、风险偏好）生成结构化交易决策。AI的输出包含决策类型（买入/卖出/持有）、详细原因、信心指数以及**建议的交易规模百分比**。

-   **模块化Agent设计**: 项目采用清晰的Agent架构，每个Agent负责特定任务，确保代码的模块化、可维护性和可扩展性。
    -   `DataAgent`: 负责加载和处理K线数据，并计算包括MA20、RSI14、MACD、**布林带 (Bollinger Bands)**、**随机振荡器 (Stochastic Oscillator)**、**平均真实范围 (ATR)** 在内的丰富技术指标，并将其转换为LLM可理解的文本格式。
    -   `NewsAgent`: 负责从NewsAPI.org获取和处理与股票相关的实时新闻，并进行清洗，为LLM提供市场情绪和事件驱动信息。
    -   `FinancialAgent`: **新增Agent**。负责从 `yfinance` 获取公司的核心基本面财务数据（如市值、市盈率、每股收益等），并将其格式化为LLM可读的文本摘要，为AI提供公司价值评估依据。
    -   `DecisionAgent`: 封装与LLM的交互逻辑，发送多维度Prompt并解析LLM返回的结构化决策。
    -   `RiskAgent`: **新增Agent**。独立于AI决策，根据预设的**止盈 (Take-Profit)** 和**止损 (Stop-Loss)** 规则，对持仓进行实时监控和强制平仓，作为策略的“安全网”。

-   **数据处理与转换**: 将复杂的结构化数据（K线、技术指标、财务数据）和非结构化数据（新闻）高效地转换为LLM易于理解的自然语言文本，确保AI能全面获取市场信息。

-   **智能示例选择**: 根据当前市场趋势（价格变化）动态选择最相关的历史K线示例，为LLM提供更精准的上下文，提升决策质量。

-   **风险偏好集成**: 用户可以输入自己的风险偏好（保守、稳健、激进、中性），LLM在决策时会考虑这一因素，调整其决策风格和交易规模。

-   **状态意识决策 (State-Aware Decision Making)**: AI在决策时会充分考虑当前的持仓状态（例如“当前持有100股AAPL”或“当前无持仓”），使其决策更贴近真实交易场景，能够进行加仓、减仓或清仓等复杂操作，而非每次都从零开始判断。

-   **动态头寸管理 (Dynamic Position Sizing)**: 本项目的核心亮点之一。AI不再简单地买卖固定数量的股票，而是根据其对市场和自身决策的**信心指数**，动态决定每次交易的**具体规模百分比**（`trade_percent`）。例如，高信心可能对应高比例的资金投入，低信心则降低风险敞口。

-   **规则化风险管理 (Rule-based Risk Management)**: `RiskAgent` 作为一个独立的风控层，在AI决策之前优先执行。它根据预设的止盈止损百分比，自动监控并强制平仓已触发风险条件的持仓，确保资金安全和利润锁定，弥补LLM决策可能存在的盲点。

-   **高度真实的AI回测系统**: `backtest.py` 脚本提供了一个强大且高度仿真的回测环境，用于在历史数据上模拟AI交易策略的表现：
    -   **包含交易成本**: 模拟真实的交易手续费，使回测结果更具参考价值。
    -   **每日详细日志**: 清晰展示回测过程中每一天的AI决策、建议仓位、持仓变化及资产变动，极大提升了透明度，方便用户复盘和分析。
    -   提供AI策略与“买入并持有”策略的详细对比报告（包括最终资产、总收益率、交易次数等）。

## 快速开始

### 1. 前提条件

-   Python 3.8+ (推荐)
-   `pip` 包管理器
-   **API密钥配置**: 本项目需要调用外部API。请在您的操作系统中设置以下两个环境变量：
    -   `DEEPSEEK_API_KEY`: 您的DeepSeek API密钥。
    -   `NEWS_API_KEY`: 您的NewsAPI.org API密钥。

### 2. 安装依赖

在项目根目录下，打开终端并运行以下命令安装所需的Python库：

```bash
pip install pandas openai yfinance requests tqdm ta python-dotenv
```

### 3. 项目结构

```
. # 项目根目录
├── main.py                 # 项目主入口，用于单次实时决策
├── backtest.py             # AI交易策略回测系统
├── agents/                 # 智能体模块
│   ├── data_agent.py       # 数据处理Agent
│   ├── decision_agent.py   # 决策Agent
│   ├── news_agent.py       # 新闻Agent
│   ├── financial_agent.py  # 财务数据Agent (新增)
│   └── risk_agent.py       # 风险管理Agent (新增)
└── prompts/                # Prompt模板模块
    └── prompt_templates.py # Prompt模板定义
```

### 4. 运行项目

**运行实时决策助手 (main.py):**

在项目根目录下，打开终端并运行主程序：

```bash
python main.py
```

程序启动后，您将被提示输入您的风险偏好和想要查询的股票代码。输入后，程序将并行加载数据、新闻和财务摘要，调用AI生成决策，并显示结果。

**示例交互 (main.py):**

```
欢迎使用AI交易决策助手！
----------------------------------
请输入您的风险偏好（保守, 稳健, 激进, 中性）：稳健
您的风险偏好设置为：稳健
请输入您想查询的股票代码（例如：AAPL, MSFT）：AAPL
您选择的股票代码为：AAPL
DecisionAgent 初始化成功，使用模型: deepseek-chat, Base URL: https://api.deepseek.com
NewsAgent 初始化成功。
FinancialAgent 初始化成功。

正在并行加载市场数据、新闻和财务摘要...
...
所有数据加载完成。
当前市场 (AAPL) 最近5天价格变化: 1.23%
找到 3 个与当前市场趋势相似的历史示例。
数据转换完成。

数据处理完成，正在构建Prompt...

--- 生成的完整Prompt ---
你是一位顶级的金融分析师，同时具备深厚的技术分析功底和严谨的基本面分析能力。你的任务是综合运用所有信息，为一笔交易生成包含具体交易规模的决策。
...
当前持仓状态：
当前无持仓。

基本面财务摘要：
- 公司名称: Apple Inc.
- 市值: 2.7T
- 市盈率(PE): 28.50

相关新闻：
【新闻】发布时间: 2025-08-15...标题: Apple发布创新产品...
...
------------------------

正在请求AI生成决策...

----------------------------------
AI分析的市场数据：
日期：2025-08-11，开盘价：227.18，最高价：228.50，最低价：226.00，收盘价：227.18，成交量：65M。
...
----------------------------------
AI交易决策：
决策: 买入
原因: 综合分析显示，AAPL基本面稳健，技术指标呈上升趋势，新闻面亦有积极信号。考虑到用户稳健的风险偏好且当前无持仓，建议适度建仓。
信心指数: 0.85
建议仓位: 60%
----------------------------------

按任意键退出...
```

**运行回测系统 (backtest.py):**

```bash
python backtest.py
```
您可以通过修改 `backtest.py` 文件末尾的配置参数来调整回测行为。

**示例输出 (backtest.py):**
```
--- 开始对 AAPL 进行回测 ---
回测周期: 最近 60 个交易日
初始资金: $10,000.00
风险偏好: 稳健
交易手续费率: 0.100%
新闻获取频率: 每 5 天
止损线: 5.00%
止盈线: 10.00%
----------------------------------
...

--- 开始每日回测循环 ---
回测进度: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:46<00:00,  9.33s/it]
日期: 2025-08-11 | 决策: 买入 | 仓位%:  50% | 持仓: 0    | 价格: $ 227.18 | 总资产: $ 9,999.77
日期: 2025-08-12 | 决策: 持有 | 仓位%:   0% | 持仓: 22   | 价格: $ 229.65 | 总资产: $10,052.07
日期: 2025-08-13 | 决策: 卖出 | 原因: 触发 10.00% 止盈线 | 价格: $ 233.33 | 总资产: $10,192.24
日期: 2025-08-14 | 决策: 持有 | 仓位%:   0% | 持仓: 0    | 价格: $ 232.78 | 总资产: $10,192.24
日期: 2025-08-15 | 决策: 买入 | 仓位%:  25% | 持仓: 0    | 价格: $ 231.59 | 总资产: $10,189.69

--- 回测结束 --- 正在生成报告 ---

--- 回测结果报告 ---
股票代码: AAPL
回测时段: 2025-08-11 to 2025-08-15
----------------------------------
AI 策略表现:
  初始资本: $10,000.00
  最终资产: $10,189.69
  总收益率: 1.90%
  交易次数: 3
----------------------------------
买入并持有策略表现:
  初始资本: $10,000.00
  最终资产: $10,194.12
  总收益率: 1.94%
----------------------------------

按任意键退出...
```

## 未来增强（路线图）

本项目仍处于原型阶段，未来可以考虑以下增强：

-   **规则化风险管理**: 增加独立的风险管理模块，对AI的决策进行二次校验。例如，实现强制的止盈止损规则，当一笔交易的盈利或亏损达到预设阈值时自动平仓。
-   **探索更优模型**: 探索使用更适合金融领域的LLM模型，或对现有模型进行微调（如果API支持）。
-   **丰富数据源**: 引入除了价格和新闻之外的更多数据维度，如宏观经济数据、财报数据、社交媒体情绪等。
-   **开发前端界面**: 开发一个用户友好的图形界面，提供更直观的交互和数据可视化。

## 贡献

欢迎对本项目提出建议或贡献代码。如果您有任何想法或发现问题，请随时提出。