# AI交易决策助手

## 项目简介

这是一个基于大型语言模型（LLM）的AI交易决策助手原型。项目旨在通过将金融市场数据转化为自然语言描述，结合用户的风险偏好，利用LLM的强大推理能力生成结构化的交易决策（买入/卖出/持有）。

本项目的核心思想是利用LLM的“少样本学习”（Few-Shot Learning）能力，通过精心设计的Prompt和模块化的Agent架构，实现高效、灵活的交易策略生成，而无需传统的机器学习模型训练。

## 当前功能

-   **LLM驱动决策**：利用DeepSeek API作为核心推理引擎，根据市场数据和用户偏好生成交易决策。
-   **模块化Agent设计**：
    -   `DataAgent`：负责加载和处理K线数据，并将其转换为LLM可理解的自然语言文本。
    -   `PromptTemplates`：管理和构建发送给LLM的Prompt模板，包含历史示例、当前数据和用户风险偏好。
    -   `DecisionAgent`：封装与LLM的交互逻辑，发送Prompt并解析LLM返回的结构化决策。
    -   `NewsAgent`：负责获取和处理新闻数据，并将其转换为LLM可理解的文本格式。
-   **异步数据获取**：通过 `asyncio` 实现市场数据和新闻数据的并行获取，显著提升了程序运行效率。
-   **数据到文本转换**：将结构化的K线数据（开盘价、收盘价、成交量等）转化为易于LLM理解的描述性文本。
-   **风险偏好集成**：用户可以输入自己的风险偏好（保守、稳健、激进、中性），LLM在决策时会考虑这一因素。
-   **结构化输出**：LLM返回的决策以JSON格式呈现，包含决策类型（买入/卖出/持有）、详细原因和信心指数。
-   **美股数据集成**：已接入 `yfinance` 库，可获取美股（如AAPL, GOOGL等）的实时（或近实时）K线数据，替换了之前的CSV模拟数据源。
-   **用户自定义股票**：用户可以在运行时输入想要查询的股票代码。
-   **直观的决策依据**：在显示AI决策前，会打印出AI所分析的最近市场数据，帮助用户理解决策依据。
-   **智能示例选择**：根据当前市场趋势（价格变化）动态选择最相关的历史K线示例，为LLM提供更精准的上下文。
-   **真实新闻数据集成**：已接入 NewsAPI.org，可获取与股票相关的实时新闻，并对新闻内容进行清洗（去除HTML标签和截断标记），新闻获取频率现在是可配置的，丰富LLM的决策依据。
-   **AI交易策略回测系统**：新增 `backtest.py` 脚本，用于在历史数据上模拟AI交易策略的表现：
    -   可配置回测天数、初始资金和用户风险偏好。
    -   回测过程中可配置新闻获取频率和中间报告打印频率。
    -   提供AI策略与“买入并持有”策略的详细对比报告（包括最终资产、总收益率、交易次数等）。

## 快速开始

### 1. 前提条件

-   Python 3.8+ (推荐)
-   `pip` 包管理器
-   **API密钥配置**：本项目需要调用外部API。请在您的操作系统中设置以下两个环境变量：
    -   `DEEPSEEK_API_KEY`: 您的DeepSeek API密钥。
    -   `NEWS_API_KEY`: 您的NewsAPI.org API密钥。

    **如何设置环境变量:**
    -   **Windows:**
        ```shell
        setx DEEPSEEK_API_KEY "您的密钥"
        setx NEWS_API_KEY "您的密钥"
        ```
        *注意：设置后需要重启终端才能生效。*
    -   **macOS / Linux:**
        ```shell
        export DEEPSEEK_API_KEY="您的密钥"
        export NEWS_API_KEY="您的密钥"
        ```
        *建议将此行添加到您的 `.bashrc`, `.zshrc` 或其他shell配置文件中，以便永久生效。*

### 2. 安装依赖

在项目根目录下，打开终端并运行以下命令安装所需的Python库：

```bash
pip install pandas openai yfinance requests tqdm
```

### 3. 项目结构

```
. # 项目根目录
├── main.py                 # 项目主入口，协调各个Agent，处理用户交互
├── backtest.py             # AI交易策略回测系统
├── agents/
│   ├── __init__.py
│   ├── data_agent.py       # 负责数据加载和文本转换
│   ├── decision_agent.py   # 负责与DeepSeek LLM交互，生成决策
│   └── news_agent.py       # 负责获取和处理新闻数据
└── prompts/
    ├── __init__.py
    └── prompt_templates.py # 负责构建LLM的Prompt模板
```

### 4. 运行项目

**运行实时决策助手 (main.py):**

在项目根目录下，打开终端并运行主程序：

```bash
python main.py
```

程序启动后，您将被提示输入您的风险偏好和想要查询的股票代码。输入后，程序将并行加载数据和新闻，调用AI生成决策，并显示结果。

**示例交互 (main.py):**

```
欢迎使用AI交易决策助手！
----------------------------------
请输入您的风险偏好（保守, 稳健, 激进, 中性）：中性
您的风险偏好设置为：中性
请输入您想查询的股票代码（例如：AAPL, MSFT）：GOOGL
您选择的股票代码为：GOOGL
DecisionAgent 初始化成功，使用模型: deepseek-chat, Base URL: https://api.deepseek.com
NewsAgent 初始化成功。

正在加载和处理市场数据...
正在从yfinance加载 GOOGL 的数据...
[*********************100%***********************]  1 of 1 completed
数据加载成功，共 60 条记录。
当前市场 (GOOGL) 最近5天价格变化: 2.49%
找到 3 个与当前市场趋势相似的历史示例。

正在获取新闻数据...
正在从NewsAPI.org获取关于 "GOOGL" 的新闻...
新闻数据处理完成。
数据处理完成，正在构建Prompt...

--- 生成的完整Prompt ---
...
------------------------

正在请求AI生成决策...

----------------------------------
AI分析的市场数据：
日期：2025-08-07，开盘价：197.06，最高价：197.54，最低价：194.33，收盘价：196.52，成交量：26321800。
日期：2025-08-08，开盘价：197.22，最高价：202.61，最低价：197.17，收盘价：201.42，成交量：39161800。
日期：2025-08-11，开盘价：200.94，最高价：201.48，最低价：199.07，收盘价：201.00，成交量：25832400。
日期：2025-08-12，开盘价：201.37，最高价：204.50，最低价：200.59，收盘价：203.34，成交量：30397900。
日期：2025-08-13，开盘价：204.13，最高价：204.53，最低价：197.51，收盘价：201.96，成交量：28324500。
----------------------------------
AI交易决策：
决策: 买入
原因: 当前市场数据显示股价呈现上升趋势，尤其是在2025-08-08和2025-08-12的交易日中，价格突破了前期高点，成交量也有所增加，显示出较强的买方力量。尽管2025-08-13出现了一定的 回调，但整体趋势仍然向上。考虑到用户的风险偏好为中性，可以在控制风险的前提下，适度参与这波上涨行情。
信心指数: 0.70
----------------------------------

按任意键退出...
```

**运行回测系统 (backtest.py):**

在项目根目录下，打开终端并运行回测程序：

```bash
python backtest.py
```

您可以通过修改 `backtest.py` 文件末尾的配置参数来调整回测行为，例如：

```python
if __name__ == '__main__':
    # --- 回测配置 ---
    TICKER = "AAPL"
    DAYS_TO_BACKTEST = 30
    INITIAL_CAPITAL = 10000.0
    RISK_PREFERENCE = "稳健" # 可选: 保守, 稳健, 激进, 中性
    NEWS_FETCH_INTERVAL = 5 # 每隔N天获取一次新闻
    REPORT_INTERVAL_DAYS = 3 # 每隔N天打印一次中间报告

    asyncio.run(run_backtest(TICKER, DAYS_TO_BACKTEST, INITIAL_CAPITAL, RISK_PREFERENCE, NEWS_FETCH_INTERVAL, REPORT_INTERVAL_DAYS))
```

## 未来增强（路线图）

本项目仍处于原型阶段，未来可以考虑以下增强：

-   **前端界面**：开发一个用户友好的图形界面，提供更直观的交互和数据可视化。
-   **风险管理模块**：增加独立的风险评估和管理Agent，对LLM的决策进行二次校验和风险控制。
-   **模型优化**：探索使用更适合金融领域的LLM模型，或对现有模型进行微调（如果API支持）。

## 贡献

欢迎对本项目提出建议或贡献代码。如果您有任何想法或发现问题，请随时提出。